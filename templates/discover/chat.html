<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    {% load chat-help %}
    {% load static from staticfiles %}
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>
    <!--[if IE]>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <![endif]-->
    <title>BOOTSTRAP CHAT EXAMPLE</title>
    <!-- BOOTSTRAP CORE STYLE CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"/>

    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        var socket;
        $(document).ready(function () {

            var lastMessage = "";

            socket = io.connect('http://' + document.domain + ':' + "5000" + '/chat');

            socket.on('connect', function () {
                socket.emit('joined', {});
            });

            socket.on('status', function (data) {
                $('#chat').val($('#chat').val() + '<' + data.msg + '>\n');
                $('#chat').scrollTop($('#chat')[0].scrollHeight);
            });

            socket.on('message', function (data) {
                var avi = "/static/assets/blank.png";
                if (data.msg != lastMessage) {
                    avi = "/static/assets/chat-avi.png"
                }
                // When new message, add chat message
                var new_message = '<li class="media"><div class="media-body"><div class="media">' +
                        '<a class="pull-left" href="#"><img class="media-object img-circle " src='+ avi +
                        '/></a><div class="media-body">' + data.msg +
                        '<br/><small class="text-muted">Alex Deo | 23rd June at 5:00pm</small><hr/></div></div></div></li>';
                $("#chat-history").append(new_message);

                // Scroll to the top of the chat

            });

            $('#text').keypress(function (e) {
                var code = e.keyCode || e.which;
                if (code == 13) {
                    lastMessage = text;
                    text = $('#text').val();
                    $('#text').val('');
                    socket.emit('text', {msg: text});
                }
            });
        });
        function leave_room() {
            socket.emit('left', {}, function () {
                socket.disconnect();

                // go back to the login page
                window.location.href = "{% url 'rater:index' %}";
            });
        }
    </script>

</head>
<body style="font-family:Verdana">
<div class="container">
    <div class="row " style="padding-top:10px;">
        <h3 class="text-center">MEMECONNECT CHAT </h3>
        <br/><br/>
        <div class="col-md-8">
            <div class="panel panel-info">
                <div class="panel-heading">
                    RECENT CHAT HISTORY
                </div>
                <div class="panel-body">
                    <ul class="media-list" id="chat-history">

                        {% for message in chat %}

                        <li class="media">

                            <div class="media-body">

                                <div class="media">
                                    <a class="pull-left" href="#">
                                        <img class="media-object img-circle " src="assets/img/user.png"/>
                                    </a>
                                    <div class="media-body">
                                        Donec sit amet ligula enim. Duis vel condimentum massa.

                                        Donec sit amet ligula enim. Duis vel condimentum massa.Donec sit amet ligula
                                        enim.
                                        Duis vel condimentum massa.
                                        Donec sit amet ligula enim. Duis vel condimentum massa.
                                        <br/>
                                        <small class="text-muted">Alex Deo | 23rd June at 5:00pm</small>
                                        <hr/>
                                    </div>
                                </div>

                            </div>
                        </li>

                        {% endfor %}
                    </ul>
                </div>
                <div class="panel-footer">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Enter Message"/>
                                    <span class="input-group-btn">
                                        <button class="btn btn-info" type="button">SEND</button>
                                    </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    YOUR MATCHES
                </div>
                <div class="panel-body">
                    <ul class="media-list">

                        {% for chat in chats %}
                            <li class="media">

                                <div class="media-body">

                                    <div class="media">
                                        <a class="pull-left" href="{% url 'rater:chat' chat_key=chat.key %}">
                                            <img class="media-object img-circle" style="max-height:40px;"
                                                 src="{% static 'assets/chat-avi.png' %}"/>
                                        </a>
                                        <div class="media-body">
                                            <h5><strong>{{ request.user|get_other:chat }}</strong></h5>

                                            <small class="text-muted">Active From 3 hours</small>
                                        </div>
                                    </div>

                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

        </div>
    </div>
</div>
</body>
</html>
